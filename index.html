<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatric Cardiac SurgeryåŠ©æ‰‹</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ«€</text></svg>">
    <style>
        /* [æ‰€æœ‰CSSæ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†ç®€æ´çœç•¥] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .disclaimer {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .disclaimer strong {
            color: #856404;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 500;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AIåŠ©æ‰‹æ ·å¼ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: white;
            border: 1px solid #dee2e6;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åŒ»å­¦è¾å…¸æ ·å¼ */
        .dictionary-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
        }

        .lang-selector {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
        }

        .translation-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
            margin-top: 20px;
        }

        .term-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        /* éšè®¿æé†’æ ·å¼ */
        .reminder-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .reminder-list {
            margin-top: 20px;
        }

        .reminder-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-item.overdue {
            border-left-color: #dc3545;
        }

        .reminder-item.upcoming {
            border-left-color: #ffc107;
        }

        /* å‚è€ƒèµ„æºæ ·å¼ */
        .resources {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .resources h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .resources ul {
            list-style: none;
        }

        .resources li {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .resources a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s;
        }

        .resources a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å¿ƒè·³åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            max-width: 80px;
        }

        .typing-indicator .heart {
            font-size: 24px;
            animation: heartbeat 1.2s ease-in-out infinite;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(1); }
        }

        @keyframes bounce {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.7;
            }
            30% { 
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* æ€è€ƒä¸­åŠ¨ç”» */
        .thinking-animation {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }

        .thinking-animation .bubble {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            animation: think 1.5s ease-in-out infinite;
        }

        .thinking-animation .bubble:nth-child(1) {
            animation-delay: 0s;
        }

        .thinking-animation .bubble:nth-child(2) {
            animation-delay: 0.3s;
        }

        .thinking-animation .bubble:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes think {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* TTSæŒ‰é’®æ ·å¼æ”¹è¿› */
        .tts-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.7;
            transition: all 0.3s;
            padding: 4px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tts-button:hover {
            opacity: 1;
            background-color: #f0f0f0;
        }

        .tts-button.speaking {
            opacity: 1;
            background-color: #e3f2fd;
        }

        .stop-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            opacity: 0.7;
            transition: all 0.3s;
            padding: 4px;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stop-button:hover {
            opacity: 1;
            background-color: #ffebee;
        }

        /* æ¶ˆæ¯ä¸­çš„TTSå®¹å™¨ */
        .tts-container {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ«€ Pediatric Cardiac SurgeryåŠ©æ‰‹</h1>
            <p>å©´å¹¼å„¿å¿ƒå¤–ç§‘æ™ºèƒ½è¾…åŠ©ç³»ç»Ÿ</p>
            <p>å¤©æ´¥èƒ¸ç§‘åŒ»é™¢å¿ƒè¡€ç®¡å¤–ç§‘åŒ»å¸ˆåˆ˜èè®¾è®¡</p>
        </div>

        <div class="disclaimer">
            <strong>âš ï¸ å…è´£å£°æ˜ / Disclaimer:</strong><br>
            æœ¬ç³»ç»Ÿæä¾›çš„ä¿¡æ¯ä»…ä¾›ä¸´åºŠå©´å¹¼å„¿å¿ƒå¤–ç§‘åŒ»ç”Ÿå‚è€ƒï¼Œä¸èƒ½ä»£æ›¿ä¸“ä¸šåŒ»ç–—åˆ¤æ–­ã€‚æ‰€æœ‰ä¸´åºŠå†³ç­–å¿…é¡»ç»“åˆæ‚£å„¿çš„å…·ä½“æƒ…å†µã€æœ€æ–°åŒ»å­¦è¯æ®å’ŒåŒ»ç”Ÿçš„ä¸“ä¸šç»éªŒç»¼åˆåˆ¤æ–­ã€‚ä½¿ç”¨æœ¬ç³»ç»Ÿå³è¡¨ç¤ºæ‚¨åŒæ„æ­¤å…è´£å£°æ˜ã€‚
            <br><br>
            <em>The information provided by this system is for reference by clinical pediatric cardiac surgeons only and cannot replace professional medical judgment. All clinical decisions must be made based on the specific conditions of the patient, latest medical evidence, and professional experience of physicians.</em>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ¤– AIåŠ©æ‰‹</button>
            <button class="tab" onclick="switchTab(1)">ğŸ“š åŒ»å­¦è¾å…¸</button>
            <button class="tab" onclick="switchTab(2)">â° éšè®¿æé†’</button>
            <button class="tab" onclick="switchTab(3)">ğŸ”— å‚è€ƒèµ„æº</button>
        </div>

        <div class="tab-content active">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€å¾·è¯­ï¼‰..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-secondary" onclick="startVoiceInput()" id="voiceBtn">ğŸ¤ è¯­éŸ³</button>
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #6c757d; font-size: 0.9em;">
                    ğŸ’¡ æç¤ºï¼šæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€å¾·è¯­æé—®å’Œå›å¤<br>
                    ğŸ¤ è¯­éŸ³è¾“å…¥æé—® | ğŸ”Š ç‚¹å‡»æ¶ˆæ¯æŒ‰é’®æœ—è¯» | â¹ï¸ åœæ­¢å½“å‰æœ—è¯»
                </div>
                <button onclick="stopSpeaking()" class="btn btn-secondary" style="padding: 8px 16px;">
                    ğŸ”‡ åœæ­¢æ‰€æœ‰æœ—è¯»
                </button>
            </div>
        </div>

        <div class="tab-content">
            <div class="dictionary-container">
                <h2 style="margin-bottom: 20px;">åŒ»å­¦æœ¯è¯­ç¿»è¯‘</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="dictInput" placeholder="è¾“å…¥åŒ»å­¦æœ¯è¯­...">
                    <select class="lang-selector" id="sourceLang">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                    </select>
                    <button class="btn btn-primary" onclick="translateTerm()">ç¿»è¯‘</button>
                </div>
                <div class="translation-result" id="translationResult">
                    <p style="color: #6c757d;">åœ¨ä¸Šæ–¹è¾“å…¥æœ¯è¯­è¿›è¡Œç¿»è¯‘...</p>
                </div>
            </div>
        </div>

        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">æ‚£è€…éšè®¿ç®¡ç†</h2>
            <div class="reminder-form">
                <h3>æ·»åŠ éšè®¿æé†’</h3>
                <div class="form-group">
                    <label>æ‚£è€…å§“å/ID:</label>
                    <input type="text" id="patientName" placeholder="è¾“å…¥æ‚£è€…æ ‡è¯†">
                </div>
                <div class="form-group">
                    <label>æ‰‹æœ¯ç±»å‹:</label>
                    <input type="text" id="surgeryType" placeholder="ä¾‹å¦‚ï¼šVSDä¿®è¡¥æœ¯">
                </div>
                <div class="form-group">
                    <label>éšè®¿æ—¥æœŸ:</label>
                    <input type="date" id="followupDate">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨:</label>
                    <textarea id="notes" rows="3" placeholder="éšè®¿æ³¨æ„äº‹é¡¹..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addReminder()">æ·»åŠ æé†’</button>
            </div>
            <div class="reminder-list" id="reminderList"></div>
        </div>

        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">ä¸»è¦å‚è€ƒåŒ»ç–—æœºæ„</h2>
            <div class="resources">
                <h3>ğŸŒ å›½é™…é¡¶å°–å„¿ç«¥å¿ƒè„ä¸­å¿ƒ</h3>
                <ul>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.dhzc.charite.de/en/" target="_blank">Deutsches Herzzentrum der CharitÃ© (DHZC)</a> - æŸæ—å¤é‡Œç‰¹å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.dhzb.de" target="_blank">Deutsches Herzzentrum Berlin (DHZB)</a> - å¾·å›½æŸæ—å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.heidelberg-university-hospital.com" target="_blank">Heidelberg University Hospital</a> - æµ·å¾·å ¡å¤§å­¦åŒ»é™¢</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.lmu-klinikum.de" target="_blank">LMU Klinikum MÃ¼nchen</a> - æ…•å°¼é»‘å¤§å­¦åŒ»é™¢</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.texaschildrens.org/heart" target="_blank">Texas Children's Heart Center</a> - å¾·å…‹è¨æ–¯å„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.chop.edu/centers-programs/cardiac-center" target="_blank">Children's Hospital of Philadelphia - Cardiac Center</a> - è´¹åŸå„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.childrenshospital.org/centers/heart-center" target="_blank">Boston Children's Hospital - Heart Center</a> - æ³¢å£«é¡¿å„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                </ul>
                
                <h3 style="margin-top: 25px;">ğŸ‡¨ğŸ‡³ ä¸­å›½ä¸»è¦å„¿ç«¥å¿ƒè„ä¸­å¿ƒ</h3>
                <ul>
                    <li><a href="https://www.scmc.com.cn/list/1404/2617.html" target="_blank">ä¸Šæµ·äº¤é€šå¤§å­¦åŒ»å­¦é™¢é™„å±ä¸Šæµ·å„¿ç«¥åŒ»å­¦ä¸­å¿ƒ - å¿ƒèƒ¸å¤–ç§‘</a></li>
                    <li><a href="https://www.fuwaihospital.org/Departments/Main/Detail/60" target="_blank">ä¸­å›½åŒ»å­¦ç§‘å­¦é™¢é˜œå¤–åŒ»é™¢ - å°å„¿å¿ƒè„å¤–ç§‘ä¸­å¿ƒ</a></li>
                    <li><a href="https://www.301hospital.com.cn/hospital/sixth/xexzwk.html" target="_blank">ä¸­å›½äººæ°‘è§£æ”¾å†›æ€»åŒ»é™¢(301åŒ»é™¢) - å°å„¿å¿ƒè„å¤–ç§‘</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        
        // å…¨å±€å˜é‡
        let chatHistory = [];
        let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isCurrentlySpeaking = false;
        let currentUtterance = null;

        // æ ‡ç­¾åˆ‡æ¢
        window.switchTab = function(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });

            if (index === 2) {
                displayReminders();
            }
        };

        // ç®€åŒ–ä½†å‡†ç¡®çš„è¯­è¨€æ£€æµ‹å‡½æ•°
        function detectLanguage(text) {
            if (!text || !text.trim()) return 'en-US';
            
            const cleanText = text.trim();
            const lowerText = cleanText.toLowerCase();
            
            // 1. ä¸­æ–‡æ£€æµ‹ - æœ€ç®€å•ç›´æ¥
            const chineseRegex = /[\u4e00-\u9fa5]/;
            if (chineseRegex.test(cleanText)) {
                return 'zh-CN';
            }
            
            // 2. å¾·è¯­æ£€æµ‹ - åŸºäºæ˜ç¡®ç‰¹å¾
            // å¾·è¯­ç‰¹æ®Šå­—ç¬¦æ˜¯æœ€æ˜ç¡®çš„æŒ‡ç¤º
            const germanSpecialChars = /[Ã¤Ã¶Ã¼ÃŸÃ„Ã–Ãœ]/;
            if (germanSpecialChars.test(cleanText)) {
                return 'de-DE';
            }
            
            // 3. æ£€æŸ¥æ˜ç¡®çš„å¾·è¯­å…³é”®è¯ï¼ˆé¿å…ä¸è‹±è¯­æ··æ·†ï¼‰
            const unambiguousGermanWords = [
                'brauchen', 'angeborene', 'herzfehler', 'kleinkindern', 
                'und', 'der', 'die', 'das', 'ein', 'eine', 'einer', 'eines',
                'ist', 'sind', 'haben', 'werden', 'kÃ¶nnen', 'mÃ¼ssen',
                'mit', 'von', 'fÃ¼r', 'auf', 'bei', 'durch',
                'ich', 'du', 'er', 'sie', 'es', 'wir', 'ihr', 'Sie'
            ];
            
            let germanScore = 0;
            unambiguousGermanWords.forEach(word => {
                // ä½¿ç”¨å•è¯è¾¹ç•Œç¡®ä¿åŒ¹é…å®Œæ•´å•è¯
                const regex = new RegExp('\\b' + word + '\\b', 'gi');
                const matches = cleanText.match(regex);
                if (matches) {
                    germanScore += matches.length;
                }
            });
            
            // 4. æ£€æŸ¥è‹±è¯­å…³é”®è¯
            const englishWords = [
                'the', 'and', 'is', 'are', 'to', 'in', 'of', 'for', 'with', 'on',
                'a', 'an', 'this', 'that', 'it', 'he', 'she', 'they',
                'have', 'has', 'do', 'does', 'can', 'will', 'should',
                'what', 'how', 'where', 'when', 'why', 'who'
            ];
            
            let englishScore = 0;
            englishWords.forEach(word => {
                const regex = new RegExp('\\b' + word + '\\b', 'gi');
                const matches = cleanText.match(regex);
                if (matches) {
                    englishScore += matches.length;
                }
            });
            
            // 5. åˆ¤æ–­é€»è¾‘
            // å¦‚æœæœ‰å¾·è¯­ç‰¹æ®Šå­—ç¬¦ï¼Œä¸€å®šæ˜¯å¾·è¯­
            if (germanSpecialChars.test(cleanText)) {
                return 'de-DE';
            }
            
            // å¦‚æœå¾·è¯­åˆ†æ•°æ˜æ˜¾é«˜äºè‹±è¯­åˆ†æ•°ï¼Œåˆ¤å®šä¸ºå¾·è¯­
            if (germanScore > 0 && germanScore > englishScore) {
                // ä½†éœ€è¦ç¡®ä¿ä¸æ˜¯è‹±è¯­è¯¯åˆ¤
                // æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„è‹±è¯­ç»“æ„
                const hasEnglishStructure = 
                    /\bthe\b/i.test(cleanText) || 
                    /\band\b/i.test(cleanText) ||
                    /\bis\b/i.test(cleanText) ||
                    /\bare\b/i.test(cleanText);
                
                if (!hasEnglishStructure || germanScore >= 3) {
                    return 'de-DE';
                }
            }
            
            // 6. é»˜è®¤è‹±è¯­
            return 'en-US';
        }

        // AIåŠ©æ‰‹åŠŸèƒ½ - ä¿®å¤è¯­è¨€åŒ¹é…é—®é¢˜
        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            // æ·»åŠ æ€è€ƒåŠ¨ç”»
            const thinkingId = addThinkingAnimation();

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            // æ£€æµ‹ç”¨æˆ·æé—®çš„è¯­è¨€
            const userLang = detectLanguage(message);
            console.log('æ£€æµ‹åˆ°çš„ç”¨æˆ·è¯­è¨€:', userLang, 'æ¶ˆæ¯:', message);
            
            let systemPrompt = '';
            let targetLang = '';
            let userMessageWithLang = message;
            
            // æ ¹æ®æ£€æµ‹åˆ°çš„ç”¨æˆ·è¯­è¨€è®¾ç½®å›å¤è¯­è¨€
            if (userLang === 'zh-CN') {
                // ä¸­æ–‡ç”¨æˆ·
                systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°å„¿å¿ƒè„å¤–ç§‘åŒ»ç”ŸåŠ©æ‰‹ã€‚ç”¨æˆ·ä½¿ç”¨ä¸­æ–‡æé—®ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ä¸­æ–‡è¿›è¡Œå›å¤ã€‚å›å¤åº”å½“ä¸“ä¸šä¸”ç®€æ´ã€‚æé†’ï¼šæ‰€æœ‰å»ºè®®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½ä»£æ›¿åŒ»ç”Ÿåˆ¤æ–­ã€‚`;
                targetLang = 'zh';
                userMessageWithLang = `${message}ï¼ˆè¯·ç”¨ä¸­æ–‡å›ç­”ï¼‰`;
                
            } else if (userLang === 'de-DE') {
                // å¾·è¯­ç”¨æˆ· - å¼ºåŒ–å¾·è¯­æŒ‡ä»¤ï¼Œé˜²æ­¢é€€å›è‹±è¯­
                systemPrompt = `Sie sind ein hochqualifizierter Assistent fÃ¼r pÃ¤diatrische Herzchirurgie. Da der Benutzer auf Deutsch fragt, mÃ¼ssen Sie AUSSCHLIESSLICH auf Deutsch antworten. ErklÃ¤ren Sie medizinische Sachverhalte prÃ¤zise. Hinweis: Alle RatschlÃ¤ge dienen nur als Referenz und ersetzen keine Ã¤rztliche Beurteilung.`;
                targetLang = 'de';
                userMessageWithLang = `${message} (BITTE ANTWORTEN SIE NUR AUF DEUTSCH)`;
                
            } else {
                // è‹±è¯­ç”¨æˆ·
                systemPrompt = `You are a professional pediatric cardiac surgery assistant. The user asks in English, reply in English. Note: For reference only, not a substitute for professional medical judgment.`;
                targetLang = 'en';
                userMessageWithLang = `${message} (Please reply in English)`;
            }

            try {
                console.log('å‘é€è¯·æ±‚åˆ°AIæœåŠ¡...', {
                    userLang: userLang,
                    targetLang: targetLang,
                    message: message
                });

                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt
                            },
                            ...chatHistory,
                            { 
                                role: 'user', 
                                content: userMessageWithLang
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 1000
                    })
                });

                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                // ç§»é™¤æ€è€ƒåŠ¨ç”»
                removeThinkingAnimation(thinkingId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯è¯¦æƒ…:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);
                
                const reply = data.choices[0].message.content;
                
                // æ£€æŸ¥å›å¤æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„è¯­è¨€
                const replyLang = detectLanguage(reply);
                console.log('AIå›å¤è¯­è¨€æ£€æµ‹:', replyLang);
                
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: reply });

                // ä¸è‡ªåŠ¨æœ—è¯»ï¼Œåªæ˜¾ç¤ºæ¶ˆæ¯
                addMessage(reply, 'assistant');
            } catch (error) {
                console.error('å®Œæ•´é”™è¯¯ä¿¡æ¯:', error);
                removeThinkingAnimation(thinkingId);
                
                // æ ¹æ®ç”¨æˆ·è¯­è¨€æä¾›é”™è¯¯ä¿¡æ¯
                let errorMsg = '';
                if (userLang === 'zh-CN') {
                    errorMsg = `æŠ±æ­‰ï¼Œè¿æ¥AIæœåŠ¡æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š<br>
                    1. DeepSeek APIå¯†é’¥æœªé…ç½®<br>
                    2. ç½‘ç»œè¿æ¥é—®é¢˜<br>
                    3. æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨<br><br>
                    è¯·æ£€æŸ¥Netlifyç¯å¢ƒå˜é‡ä¸­çš„DEEPSEEK_API_KEYè®¾ç½®ã€‚`;
                } else if (userLang === 'de-DE') {
                    errorMsg = `Entschuldigung, beim Verbinden mit dem KI-Dienst ist ein Fehler aufgetreten: ${error.message}. MÃ¶gliche Ursachen:<br>
                    1. DeepSeek API-SchlÃ¼ssel nicht konfiguriert<br>
                    2. Netzwerkverbindungsproblem<br>
                    3. Server vorÃ¼bergehend nicht verfÃ¼gbar<br><br>
                    Bitte Ã¼berprÃ¼fen Sie die DEEPSEEK_API_KEY-Umgebungsvariable in Netlify.`;
                } else {
                    errorMsg = `Sorry, an error occurred while connecting to the AI service: ${error.message}. Possible causes:<br>
                    1. DeepSeek API key not configured<br>
                    2. Network connection issue<br>
                    3. Server temporarily unavailable<br><br>
                    Please check the DEEPSEEK_API_KEY environment variable in Netlify.`;
                }
                
                addMessage(errorMsg, 'assistant');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'å‘é€';
            }
        }

        function addThinkingAnimation() {
            const messagesDiv = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            const thinkingId = 'thinking-' + Date.now();
            thinkingDiv.id = thinkingId;
            thinkingDiv.className = 'message assistant';
            thinkingDiv.innerHTML = `
                <div class="thinking-animation">
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                </div>
            `;
            messagesDiv.appendChild(thinkingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return thinkingId;
        }

        function removeThinkingAnimation(thinkingId) {
            const thinkingDiv = document.getElementById(thinkingId);
            if (thinkingDiv) {
                thinkingDiv.remove();
            }
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // æ£€æµ‹æ¶ˆæ¯è¯­è¨€ - è¿™é‡Œè¦ç¡®ä¿å‡†ç¡®
            const msgLang = detectLanguage(text);
            console.log('TTSè¯­è¨€æ£€æµ‹:', msgLang, 'æ–‡æœ¬:', text.substring(0, 50));
            
            const langCode = msgLang.split('-')[0];
            const langBadge = {
                'zh': 'ğŸ‡¨ğŸ‡³',
                'de': 'ğŸ‡©ğŸ‡ª',
                'en': 'ğŸ‡ºğŸ‡¸'
            }[langCode] || '';
            
            // ä¸ºæ¶ˆæ¯æ·»åŠ TTSåŠŸèƒ½
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            // åˆ›å»ºTTSæŒ‰é’®å®¹å™¨
            const ttsContainer = document.createElement('div');
            ttsContainer.className = 'tts-container';
            
            // åˆ›å»ºæœ—è¯»æŒ‰é’®
            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'tts-button';
            ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
            ttsBtn.title = 'ç‚¹å‡»æœ—è¯»ï¼ˆ' + msgLang + 'ï¼‰';
            
            // åˆ›å»ºåœæ­¢æŒ‰é’®
            const stopBtn = document.createElement('button');
            stopBtn.className = 'stop-button';
            stopBtn.innerHTML = 'â¹ï¸';
            stopBtn.title = 'åœæ­¢æœ—è¯»';
            stopBtn.style.display = 'none';
            
            // å½“å‰æ˜¯å¦åœ¨æœ—è¯»çš„æ ‡å¿—ï¼ˆé’ˆå¯¹è¿™æ¡æ¶ˆæ¯ï¼‰
            let isThisMessageSpeaking = false;
            
            // æœ—è¯»æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è¯­è¨€
            ttsBtn.onclick = () => {
                if (isThisMessageSpeaking) {
                    // å¦‚æœæ­£åœ¨æœ—è¯»ï¼Œç‚¹å‡»åœæ­¢
                    stopSpeaking();
                    ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                    ttsBtn.classList.remove('speaking');
                    stopBtn.style.display = 'none';
                    isThisMessageSpeaking = false;
                } else {
                    // å¦‚æœæœªåœ¨æœ—è¯»ï¼Œå…ˆåœæ­¢å…¶ä»–æ‰€æœ‰æœ—è¯»
                    stopSpeaking();
                    
                    // å¼€å§‹æœ—è¯»è¿™æ¡æ¶ˆæ¯ï¼Œä½¿ç”¨æ£€æµ‹åˆ°çš„æ­£ç¡®è¯­è¨€
                    speakText(text, msgLang); // æ˜ç¡®ä¼ é€’æ£€æµ‹åˆ°çš„è¯­è¨€
                    ttsBtn.innerHTML = 'ğŸ”‰' + langBadge;
                    ttsBtn.classList.add('speaking');
                    stopBtn.style.display = 'inline-flex';
                    isThisMessageSpeaking = true;
                    
                    // ç›‘å¬æœ—è¯»ç»“æŸäº‹ä»¶
                    if (currentUtterance) {
                        currentUtterance.onend = () => {
                            ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                            ttsBtn.classList.remove('speaking');
                            stopBtn.style.display = 'none';
                            isThisMessageSpeaking = false;
                            isCurrentlySpeaking = false;
                            currentUtterance = null;
                        };
                        
                        currentUtterance.onerror = () => {
                            ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                            ttsBtn.classList.remove('speaking');
                            stopBtn.style.display = 'none';
                            isThisMessageSpeaking = false;
                            isCurrentlySpeaking = false;
                            currentUtterance = null;
                        };
                    }
                }
            };
            
            // åœæ­¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            stopBtn.onclick = () => {
                stopSpeaking();
                ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                ttsBtn.classList.remove('speaking');
                stopBtn.style.display = 'none';
                isThisMessageSpeaking = false;
            };
            
            // ç»„è£…ç»„ä»¶
            ttsContainer.appendChild(ttsBtn);
            ttsContainer.appendChild(stopBtn);
            
            messageDiv.appendChild(textSpan);
            if (sender === 'assistant') {
                messageDiv.appendChild(ttsContainer);
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        window.handleKeyPress = function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // è¯­éŸ³è¾“å…¥
        window.startVoiceInput = function() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.innerHTML = 'ğŸ¤ å½•éŸ³ä¸­...';
            voiceBtn.disabled = true;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chatInput').value = transcript;
            };

            recognition.onerror = (event) => {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                if (event.error === 'no-speech') {
                    alert('æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•');
                } else {
                    alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };

            recognition.onend = () => {
                voiceBtn.innerHTML = 'ğŸ¤ è¯­éŸ³';
                voiceBtn.disabled = false;
            };

            recognition.start();
        }

        // æ–‡å­—è½¬è¯­éŸ³ - ä½¿ç”¨æ˜ç¡®ä¼ é€’çš„è¯­è¨€
        function speakText(text, forcedLang = null) {
            if (!text || !text.trim()) return;
            
            if (isCurrentlySpeaking) {
                stopSpeaking();
            }

            // æ¸…ç†æ–‡æœ¬
            const cleanedText = cleanTextForSpeech(text);
            
            if (!cleanedText.trim()) {
                console.log('æ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡æœ—è¯»');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            currentUtterance = utterance;
            
            // ä½¿ç”¨å¼ºåˆ¶ä¼ é€’çš„è¯­è¨€ï¼Œæˆ–è€…æ£€æµ‹è¯­è¨€
            let detectedLang = forcedLang;
            if (!detectedLang) {
                detectedLang = detectLanguage(cleanedText);
            }
            
            console.log('TTSä½¿ç”¨è¯­è¨€:', detectedLang);
            utterance.lang = detectedLang;
            
            // æ ¹æ®è¯­è¨€è°ƒæ•´è¯­é€Ÿ
            if (detectedLang === 'de-DE') {
                utterance.rate = 0.85;
            } else if (detectedLang === 'en-US') {
                utterance.rate = 0.9;
            } else {
                utterance.rate = 0.9;
            }
            
            utterance.pitch = 1;
            utterance.volume = 1;
            
            // æœ—è¯»å®Œæˆåçš„åé¦ˆ
            utterance.onend = () => {
                console.log('æœ—è¯»å®Œæˆï¼Œè¯­è¨€:', detectedLang);
                isCurrentlySpeaking = false;
                currentUtterance = null;
                
                // é‡ç½®æ‰€æœ‰TTSæŒ‰é’®çŠ¶æ€
                resetAllTTSButtons();
            };
            
            utterance.onerror = (event) => {
                console.error('æœ—è¯»å‡ºé”™:', event);
                isCurrentlySpeaking = false;
                currentUtterance = null;
                
                // å‡ºé”™æ—¶ä¹Ÿé‡ç½®æŒ‰é’®çŠ¶æ€
                resetAllTTSButtons();
            };
            
            synthesis.speak(utterance);
            isCurrentlySpeaking = true;
        }

        // é‡ç½®æ‰€æœ‰TTSæŒ‰é’®çŠ¶æ€
        function resetAllTTSButtons() {
            const ttsButtons = document.querySelectorAll('.tts-button');
            ttsButtons.forEach(btn => {
                const originalHtml = btn.innerHTML;
                if (originalHtml.includes('ğŸ”‰')) {
                    const langBadge = originalHtml.replace('ğŸ”‰', '').trim();
                    btn.innerHTML = 'ğŸ”Š' + langBadge;
                    btn.classList.remove('speaking');
                }
            });
            
            const stopButtons = document.querySelectorAll('.stop-button');
            stopButtons.forEach(btn => {
                btn.style.display = 'none';
            });
        }

        // æ¸…ç†æ–‡æœ¬ç”¨äºè¯­éŸ³æ’­æ”¾
        function cleanTextForSpeech(text) {
            let cleaned = text;
            
            // ç§»é™¤Markdownæ ¼å¼ç¬¦å·
            cleaned = cleaned.replace(/\*\*/g, '');
            cleaned = cleaned.replace(/\*/g, '');
            cleaned = cleaned.replace(/~~(.+?)~~/g, '$1');
            cleaned = cleaned.replace(/`([^`]+)`/g, '$1');
            cleaned = cleaned.replace(/```[\s\S]*?```/g, '');
            cleaned = cleaned.replace(/#{1,6}\s*/g, '');
            cleaned = cleaned.replace(/^\s*[-*+]\s+/gm, '');
            cleaned = cleaned.replace(/^\s*\d+\.\s+/gm, '');
            cleaned = cleaned.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
            
            // æ¸…ç†å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
            cleaned = cleaned.replace(/\n\s*\n/g, 'ã€‚');
            cleaned = cleaned.replace(/\n/g, 'ï¼Œ');
            cleaned = cleaned.replace(/\s+/g, ' ');
            cleaned = cleaned.trim();
            
            return cleaned;
        }

        // åœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾
        window.stopSpeaking = function() {
            if (synthesis.speaking) {
                synthesis.cancel();
                console.log('å·²åœæ­¢æœ—è¯»');
            }
            
            isCurrentlySpeaking = false;
            currentUtterance = null;
            
            // é‡ç½®æ‰€æœ‰TTSæŒ‰é’®çŠ¶æ€
            resetAllTTSButtons();
        }

        // åŒ»å­¦è¾å…¸åŠŸèƒ½
        window.translateTerm = async function() {
            const input = document.getElementById('dictInput').value.trim();
            const sourceLang = document.getElementById('sourceLang').value;
            const resultDiv = document.getElementById('translationResult');

            if (!input) {
                resultDiv.innerHTML = '<p style="color: #dc3545;">è¯·è¾“å…¥è¦ç¿»è¯‘çš„æœ¯è¯­</p>';
                return;
            }

            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="typing-indicator" style="margin: 0 auto;">
                        <span class="heart">ğŸ’™</span>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <p style="margin-top: 15px; color: #667eea;">æ­£åœ¨ç¿»è¯‘ä¸­...</p>
                </div>
            `;

            try {
                const response = await fetch('/.netlify/functions/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        term: input,
                        sourceLang: sourceLang
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                const translation = data.choices[0].message.content;

                resultDiv.innerHTML = `
                    <div class="term-card">
                        <h3>ğŸ“– ç¿»è¯‘ç»“æœ</h3>
                        <div style="white-space: pre-wrap; line-height: 1.8; padding: 10px; background: white; border-radius: 5px;" id="translationText">${translation}</div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="speakTranslationText('${translation.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š è‡ªåŠ¨è¯†åˆ«æœ—è¯»
                            </button>
                            <button onclick="speakTranslation('zh-CN')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š ä¸­æ–‡æœ—è¯»
                            </button>
                            <button onclick="speakTranslation('en-US')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š English
                            </button>
                            <button onclick="speakTranslation('de-DE')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š Deutsch
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('ç¿»è¯‘é”™è¯¯:', error);
                resultDiv.innerHTML = '<p class="error-message">ç¿»è¯‘å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }

        // ç¿»è¯‘ç»“æœæœ—è¯»ï¼ˆæŒ‡å®šè¯­è¨€ï¼‰
        window.speakTranslation = function(lang) {
            const translationDiv = document.getElementById('translationText');
            if (!translationDiv) return;

            const text = translationDiv.textContent;
            if (!text.trim()) return;

            if (isCurrentlySpeaking) {
                stopSpeaking();
            }

            // æ¸…ç†æ–‡æœ¬
            const cleanedText = cleanTextForSpeech(text);
            
            if (!cleanedText.trim()) {
                console.log('æ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡æœ—è¯»');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            currentUtterance = utterance;
            utterance.lang = lang;
            
            // æ ¹æ®è¯­è¨€è°ƒæ•´è¯­é€Ÿ
            if (lang === 'de-DE') {
                utterance.rate = 0.85;
            } else if (lang === 'en-US') {
                utterance.rate = 0.9;
            } else {
                utterance.rate = 0.9;
            }
            
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.on