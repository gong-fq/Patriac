<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatric Cardiac SurgeryåŠ©æ‰‹</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ«€</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .disclaimer {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .disclaimer strong {
            color: #856404;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 500;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AIåŠ©æ‰‹æ ·å¼ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: white;
            border: 1px solid #dee2e6;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åŒ»å­¦è¾å…¸æ ·å¼ */
        .dictionary-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
        }

        .lang-selector {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
        }

        .translation-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
            margin-top: 20px;
        }

        .term-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        /* éšè®¿æé†’æ ·å¼ */
        .reminder-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .reminder-list {
            margin-top: 20px;
        }

        .reminder-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-item.overdue {
            border-left-color: #dc3545;
        }

        .reminder-item.upcoming {
            border-left-color: #ffc107;
        }

        /* å‚è€ƒèµ„æºæ ·å¼ */
        .resources {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .resources h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .resources ul {
            list-style: none;
        }

        .resources li {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .resources a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s;
        }

        .resources a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å¿ƒè·³åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            max-width: 80px;
        }

        .typing-indicator .heart {
            font-size: 24px;
            animation: heartbeat 1.2s ease-in-out infinite;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(1); }
        }

        @keyframes bounce {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.7;
            }
            30% { 
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* æ€è€ƒä¸­åŠ¨ç”» */
        .thinking-animation {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }

        .thinking-animation .bubble {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            animation: think 1.5s ease-in-out infinite;
        }

        .thinking-animation .bubble:nth-child(1) {
            animation-delay: 0s;
        }

        .thinking-animation .bubble:nth-child(2) {
            animation-delay: 0.3s;
        }

        .thinking-animation .bubble:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes think {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* TTSæŒ‰é’®æ ·å¼æ”¹è¿› */
        .tts-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.7;
            transition: all 0.3s;
            padding: 4px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tts-button:hover {
            opacity: 1;
            background-color: #f0f0f0;
        }

        .tts-button.speaking {
            opacity: 1;
            background-color: #e3f2fd;
        }

        .stop-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            opacity: 0.7;
            transition: all 0.3s;
            padding: 4px;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stop-button:hover {
            opacity: 1;
            background-color: #ffebee;
        }

        /* æ¶ˆæ¯ä¸­çš„TTSå®¹å™¨ */
        .tts-container {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ«€ Pediatric Cardiac SurgeryåŠ©æ‰‹</h1>
            <p>å©´å¹¼å„¿å¿ƒå¤–ç§‘æ™ºèƒ½è¾…åŠ©ç³»ç»Ÿ</p>
            <p>å¤©æ´¥èƒ¸ç§‘åŒ»é™¢å¿ƒè¡€ç®¡å¤–ç§‘åŒ»å¸ˆåˆ˜èè®¾è®¡</p>
        </div>

        <div class="disclaimer">
            <strong>âš ï¸ å…è´£å£°æ˜ / Disclaimer:</strong><br>
            æœ¬ç³»ç»Ÿæä¾›çš„ä¿¡æ¯ä»…ä¾›ä¸´åºŠå©´å¹¼å„¿å¿ƒå¤–ç§‘åŒ»ç”Ÿå‚è€ƒï¼Œä¸èƒ½ä»£æ›¿ä¸“ä¸šåŒ»ç–—åˆ¤æ–­ã€‚æ‰€æœ‰ä¸´åºŠå†³ç­–å¿…é¡»ç»“åˆæ‚£å„¿çš„å…·ä½“æƒ…å†µã€æœ€æ–°åŒ»å­¦è¯æ®å’ŒåŒ»ç”Ÿçš„ä¸“ä¸šç»éªŒç»¼åˆåˆ¤æ–­ã€‚ä½¿ç”¨æœ¬ç³»ç»Ÿå³è¡¨ç¤ºæ‚¨åŒæ„æ­¤å…è´£å£°æ˜ã€‚
            <br><br>
            <em>The information provided by this system is for reference by clinical pediatric cardiac surgeons only and cannot replace professional medical judgment. All clinical decisions must be made based on the specific conditions of the patient, latest medical evidence, and professional experience of physicians.</em>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ¤– AIåŠ©æ‰‹</button>
            <button class="tab" onclick="switchTab(1)">ğŸ“š åŒ»å­¦è¾å…¸</button>
            <button class="tab" onclick="switchTab(2)">â° éšè®¿æé†’</button>
            <button class="tab" onclick="switchTab(3)">ğŸ”— å‚è€ƒèµ„æº</button>
        </div>

        <!-- AIåŠ©æ‰‹ -->
        <div class="tab-content active">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€å¾·è¯­ï¼‰..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-secondary" onclick="startVoiceInput()" id="voiceBtn">ğŸ¤ è¯­éŸ³</button>
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #6c757d; font-size: 0.9em;">
                    ğŸ’¡ æç¤ºï¼šæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€å¾·è¯­æé—®å’Œå›å¤<br>
                    ğŸ¤ è¯­éŸ³è¾“å…¥æé—® | ğŸ”Š ç‚¹å‡»æ¶ˆæ¯æŒ‰é’®æœ—è¯» | â¹ï¸ åœæ­¢å½“å‰æœ—è¯»
                </div>
                <button onclick="stopSpeaking()" class="btn btn-secondary" style="padding: 8px 16px;">
                    ğŸ”‡ åœæ­¢æ‰€æœ‰æœ—è¯»
                </button>
            </div>
        </div>

        <!-- åŒ»å­¦è¾å…¸ -->
        <div class="tab-content">
            <div class="dictionary-container">
                <h2 style="margin-bottom: 20px;">åŒ»å­¦æœ¯è¯­ç¿»è¯‘</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="dictInput" placeholder="è¾“å…¥åŒ»å­¦æœ¯è¯­...">
                    <select class="lang-selector" id="sourceLang">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                    </select>
                    <button class="btn btn-primary" onclick="translateTerm()">ç¿»è¯‘</button>
                </div>
                <div class="translation-result" id="translationResult">
                    <p style="color: #6c757d;">åœ¨ä¸Šæ–¹è¾“å…¥æœ¯è¯­è¿›è¡Œç¿»è¯‘...</p>
                </div>
            </div>
        </div>

        <!-- éšè®¿æé†’ -->
        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">æ‚£è€…éšè®¿ç®¡ç†</h2>
            <div class="reminder-form">
                <h3>æ·»åŠ éšè®¿æé†’</h3>
                <div class="form-group">
                    <label>æ‚£è€…å§“å/ID:</label>
                    <input type="text" id="patientName" placeholder="è¾“å…¥æ‚£è€…æ ‡è¯†">
                </div>
                <div class="form-group">
                    <label>æ‰‹æœ¯ç±»å‹:</label>
                    <input type="text" id="surgeryType" placeholder="ä¾‹å¦‚ï¼šVSDä¿®è¡¥æœ¯">
                </div>
                <div class="form-group">
                    <label>éšè®¿æ—¥æœŸ:</label>
                    <input type="date" id="followupDate">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨:</label>
                    <textarea id="notes" rows="3" placeholder="éšè®¿æ³¨æ„äº‹é¡¹..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addReminder()">æ·»åŠ æé†’</button>
            </div>
            <div class="reminder-list" id="reminderList"></div>
        </div>

        <!-- å‚è€ƒèµ„æº -->
        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">ä¸»è¦å‚è€ƒåŒ»ç–—æœºæ„</h2>
            <div class="resources">
                <h3>ğŸŒ å›½é™…é¡¶å°–å„¿ç«¥å¿ƒè„ä¸­å¿ƒ</h3>
                <ul>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.dhzc.charite.de/en/" target="_blank">Deutsches Herzzentrum der CharitÃ© (DHZC)</a> - æŸæ—å¤é‡Œç‰¹å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.dhzb.de" target="_blank">Deutsches Herzzentrum Berlin (DHZB)</a> - å¾·å›½æŸæ—å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.heidelberg-university-hospital.com" target="_blank">Heidelberg University Hospital</a> - æµ·å¾·å ¡å¤§å­¦åŒ»é™¢</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.lmu-klinikum.de" target="_blank">LMU Klinikum MÃ¼nchen</a> - æ…•å°¼é»‘å¤§å­¦åŒ»é™¢</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.texaschildrens.org/heart" target="_blank">Texas Children's Heart Center</a> - å¾·å…‹è¨æ–¯å„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.chop.edu/centers-programs/cardiac-center" target="_blank">Children's Hospital of Philadelphia - Cardiac Center</a> - è´¹åŸå„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.childrenshospital.org/centers/heart-center" target="_blank">Boston Children's Hospital - Heart Center</a> - æ³¢å£«é¡¿å„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                </ul>
                
                <h3 style="margin-top: 25px;">ğŸ‡¨ğŸ‡³ ä¸­å›½ä¸»è¦å„¿ç«¥å¿ƒè„ä¸­å¿ƒ</h3>
                <ul>
                    <li><a href="https://www.scmc.com.cn/list/1404/2617.html" target="_blank">ä¸Šæµ·äº¤é€šå¤§å­¦åŒ»å­¦é™¢é™„å±ä¸Šæµ·å„¿ç«¥åŒ»å­¦ä¸­å¿ƒ - å¿ƒèƒ¸å¤–ç§‘</a></li>
                    <li><a href="https://www.fuwaihospital.org/Departments/Main/Detail/60" target="_blank">ä¸­å›½åŒ»å­¦ç§‘å­¦é™¢é˜œå¤–åŒ»é™¢ - å°å„¿å¿ƒè„å¤–ç§‘ä¸­å¿ƒ</a></li>
                    <li><a href="https://www.301hospital.com.cn/hospital/sixth/xexzwk.html" target="_blank">ä¸­å›½äººæ°‘è§£æ”¾å†›æ€»åŒ»é™¢(301åŒ»é™¢) - å°å„¿å¿ƒè„å¤–ç§‘</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        
        // å…¨å±€å˜é‡
        let chatHistory = [];
        let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isCurrentlySpeaking = false;
        let currentUtterance = null;

        // æ ‡ç­¾åˆ‡æ¢
        window.switchTab = function(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });

            if (index === 2) {
                displayReminders();
            }
        };

        // å¢å¼ºçš„è¯­è¨€æ£€æµ‹å‡½æ•°
        function detectLanguage(text) {
            // æ¸…ç†æ–‡æœ¬ï¼Œå»é™¤æ ‡ç‚¹ç¬¦å·
            const cleanText = text.replace(/[^\w\s\u4e00-\u9fa5Ã¤Ã¶Ã¼ÃŸÃ„Ã–Ãœ]/gi, '').trim();
            
            if (!cleanText) return 'en';
            
            // ç»Ÿè®¡å­—ç¬¦ç±»å‹
            const chineseChars = cleanText.match(/[\u4e00-\u9fa5]/g) || [];
            const germanChars = cleanText.match(/[Ã¤Ã¶Ã¼ÃŸÃ„Ã–Ãœ]/gi) || [];
            
            // å¾·è¯­ç‰¹å¾è¯
            const germanWords = ['und', 'der', 'die', 'das', 'ist', 'sind', 'haben', 'werden', 'mit', 'von', 'fÃ¼r', 'auf', 'bei', 'durch', 
                                'ein', 'eine', 'ich', 'du', 'er', 'sie', 'es', 'wir', 'ihr', 'sie', 'Sie'];
            
            // æ£€æŸ¥å¾·è¯­ç‰¹å¾è¯
            let germanWordCount = 0;
            const lowerText = cleanText.toLowerCase();
            germanWords.forEach(word => {
                const regex = new RegExp('\\b' + word + '\\b', 'gi');
                const matches = lowerText.match(regex);
                if (matches) germanWordCount += matches.length;
            });
            
            // åˆ¤æ–­é€»è¾‘ï¼ˆä¼˜å…ˆçº§ï¼šä¸­æ–‡ > å¾·è¯­ > è‹±è¯­ï¼‰
            
            // 1. å¦‚æœæœ‰ä¸­æ–‡æ±‰å­—ï¼Œä¸”å æ¯”è¶…è¿‡20%æˆ–ç»å¯¹æ•°é‡>2
            if (chineseChars.length > 0 && (chineseChars.length > 2 || chineseChars.length / cleanText.length > 0.2)) {
                return 'zh-CN';
            }
            
            // 2. å¦‚æœæœ‰å¾·è¯­ç‰¹æ®Šå­—ç¬¦æˆ–å¾·è¯­ç‰¹å¾è¯è¾ƒå¤š
            if (germanChars.length > 0 || germanWordCount >= 2) {
                // æ£€æŸ¥æ˜¯å¦ä¸»è¦æ˜¯å¾·è¯­ï¼ˆå¾·è¯­å­—ç¬¦/å•è¯å ä¸»å¯¼ï¼‰
                const totalChars = cleanText.length;
                const germanIndicator = (germanChars.length + germanWordCount) / totalChars;
                
                if (germanIndicator > 0.15) {
                    return 'de-DE';
                }
            }
            
            // 3. é»˜è®¤è‹±è¯­
            return 'en-US';
        }

        // AIåŠ©æ‰‹åŠŸèƒ½ - ä¿®å¤è¯­è¨€åŒ¹é…é—®é¢˜
        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            // æ·»åŠ æ€è€ƒåŠ¨ç”»
            const thinkingId = addThinkingAnimation();

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            // æ£€æµ‹ç”¨æˆ·æé—®çš„è¯­è¨€
            const userLang = detectLanguage(message);
            console.log('æ£€æµ‹åˆ°çš„ç”¨æˆ·è¯­è¨€:', userLang, 'æ¶ˆæ¯:', message);
            
            let systemPrompt = '';
            let targetLang = '';
            let userMessageWithLang = message;
            
            // æ ¹æ®æ£€æµ‹åˆ°çš„ç”¨æˆ·è¯­è¨€è®¾ç½®å›å¤è¯­è¨€ - ä¿®å¤ç‰ˆ
            if (userLang === 'zh-CN') {
                // ä¸­æ–‡ç”¨æˆ·
                systemPrompt = `ä½ æ˜¯ä¸€åä¸“ä¸šçš„å°å„¿å¿ƒè„å¤–ç§‘åŒ»ç”ŸåŠ©æ‰‹ã€‚ç”¨æˆ·ç”¨ä¸­æ–‡æé—®ï¼Œä½ å¿…é¡»ç”¨ä¸­æ–‡å›å¤ã€‚
                
è¦æ±‚ï¼š
1. åªç”¨ä¸­æ–‡å›å¤ï¼Œä¸è¦ä½¿ç”¨ä»»ä½•è‹±è¯­æˆ–å¾·è¯­
2. å›å¤è¦ä¸“ä¸šã€å‡†ç¡®ã€ç®€æ´
3. æé†’ç”¨æˆ·ï¼šæœ¬å»ºè®®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—åˆ¤æ–­
4. ä¸è¦æä¾›å…¶ä»–è¯­è¨€çš„ç¿»è¯‘
5. ä¸“æ³¨äºå°å„¿å¿ƒè„å¤–ç§‘ä¸“ä¸šé¢†åŸŸ

è¯·å¼€å§‹ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚`;
                targetLang = 'zh';
                userMessageWithLang = `${message}ï¼ˆè¯·ç”¨ä¸­æ–‡å›ç­”ï¼‰`;
                
            } else if (userLang === 'de-DE') {
                // å¾·è¯­ç”¨æˆ· - ä¿®å¤ï¼šç¡®ä¿AIåªç”¨å¾·è¯­å›å¤
                systemPrompt = `Sie sind ein professioneller Assistent fÃ¼r pÃ¤diatrische Herzchirurgie. Der Benutzer fragt auf Deutsch, Sie mÃ¼ssen auf Deutsch antworten.
                
Anforderungen:
1. Antworten Sie ausschlieÃŸlich auf Deutsch, verwenden Sie keine andere Sprache
2. Die Antwort muss professionell, prÃ¤zise und prÃ¤gnant sein
3. Erinnern Sie den Benutzer: Diese Informationen dienen nur als Referenz und ersetzen keine medizinische Beurteilung
4. Geben Sie keine Ãœbersetzungen in andere Sprachen
5. Konzentrieren Sie sich auf das Fachgebiet der pÃ¤diatrischen Herzchirurgie

Bitte antworten Sie jetzt auf Deutsch auf die Frage des Benutzers.`;
                targetLang = 'de';
                userMessageWithLang = `${message} (Bitte antworten Sie auf Deutsch)`;
                
            } else {
                // è‹±è¯­ç”¨æˆ·
                systemPrompt = `You are a professional pediatric cardiac surgery assistant. The user asks in English, you must reply in English.
                
Requirements:
1. Reply in English only, do not use any other language
2. The reply should be professional, accurate, and concise
3. Remind the user: This information is for reference only and does not replace medical judgment
4. Do not provide translations in other languages
5. Focus on the pediatric cardiac surgery specialty

Please reply in English to the user's question now.`;
                targetLang = 'en';
                userMessageWithLang = `${message} (Please reply in English)`;
            }

            try {
                console.log('å‘é€è¯·æ±‚åˆ°AIæœåŠ¡...', {
                    userLang: userLang,
                    targetLang: targetLang,
                    message: message
                });

                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt
                            },
                            ...chatHistory.map(msg => {
                                // ç¡®ä¿å†å²æ¶ˆæ¯ä¹Ÿç¬¦åˆå½“å‰è¯­è¨€è¦æ±‚
                                if (msg.role === 'user') {
                                    return {
                                        role: 'user',
                                        content: `${msg.content} (${targetLang === 'zh' ? 'è¯·ç”¨ä¸­æ–‡' : targetLang === 'de' ? 'Bitte auf Deutsch' : 'Please in English'})`
                                    };
                                }
                                return msg;
                            }),
                            { 
                                role: 'user', 
                                content: userMessageWithLang
                            }
                        ],
                        temperature: 0.3, // é™ä½temperatureä»¥è·å¾—æ›´ç¡®å®šçš„å›å¤
                        max_tokens: 1000
                    })
                });

                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                // ç§»é™¤æ€è€ƒåŠ¨ç”»
                removeThinkingAnimation(thinkingId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯è¯¦æƒ…:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);
                
                const reply = data.choices[0].message.content;
                
                // æ£€æŸ¥å›å¤æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„è¯­è¨€
                const replyLang = detectLanguage(reply);
                console.log('AIå›å¤è¯­è¨€æ£€æµ‹:', replyLang);
                
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: reply });

                // ä¸è‡ªåŠ¨æœ—è¯»ï¼Œåªæ˜¾ç¤ºæ¶ˆæ¯
                addMessage(reply, 'assistant');
            } catch (error) {
                console.error('å®Œæ•´é”™è¯¯ä¿¡æ¯:', error);
                removeThinkingAnimation(thinkingId);
                
                // æ ¹æ®ç”¨æˆ·è¯­è¨€æä¾›é”™è¯¯ä¿¡æ¯
                let errorMsg = '';
                if (userLang === 'zh-CN') {
                    errorMsg = `æŠ±æ­‰ï¼Œè¿æ¥AIæœåŠ¡æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š<br>
                    1. DeepSeek APIå¯†é’¥æœªé…ç½®<br>
                    2. ç½‘ç»œè¿æ¥é—®é¢˜<br>
                    3. æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨<br><br>
                    è¯·æ£€æŸ¥Netlifyç¯å¢ƒå˜é‡ä¸­çš„DEEPSEEK_API_KEYè®¾ç½®ã€‚`;
                } else if (userLang === 'de-DE') {
                    errorMsg = `Entschuldigung, beim Verbinden mit dem KI-Dienst ist ein Fehler aufgetreten: ${error.message}. MÃ¶gliche Ursachen:<br>
                    1. DeepSeek API-SchlÃ¼ssel nicht konfiguriert<br>
                    2. Netzwerkverbindungsproblem<br>
                    3. Server vorÃ¼bergehend nicht verfÃ¼gbar<br><br>
                    Bitte Ã¼berprÃ¼fen Sie die DEEPSEEK_API_KEY-Umgebungsvariable in Netlify.`;
                } else {
                    errorMsg = `Sorry, an error occurred while connecting to the AI service: ${error.message}. Possible causes:<br>
                    1. DeepSeek API key not configured<br>
                    2. Network connection issue<br>
                    3. Server temporarily unavailable<br><br>
                    Please check the DEEPSEEK_API_KEY environment variable in Netlify.`;
                }
                
                addMessage(errorMsg, 'assistant');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'å‘é€';
            }
        }

        function addThinkingAnimation() {
            const messagesDiv = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            const thinkingId = 'thinking-' + Date.now();
            thinkingDiv.id = thinkingId;
            thinkingDiv.className = 'message assistant';
            thinkingDiv.innerHTML = `
                <div class="thinking-animation">
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                </div>
            `;
            messagesDiv.appendChild(thinkingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return thinkingId;
        }

        function removeThinkingAnimation(thinkingId) {
            const thinkingDiv = document.getElementById(thinkingId);
            if (thinkingDiv) {
                thinkingDiv.remove();
            }
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // æ£€æµ‹æ¶ˆæ¯è¯­è¨€
            const msgLang = detectLanguage(text);
            const langCode = msgLang.split('-')[0];
            const langBadge = {
                'zh': 'ğŸ‡¨ğŸ‡³',
                'de': 'ğŸ‡©ğŸ‡ª',
                'en': 'ğŸ‡ºğŸ‡¸'
            }[langCode] || '';
            
            // ä¸ºæ¶ˆæ¯æ·»åŠ TTSåŠŸèƒ½
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            // åˆ›å»ºTTSæŒ‰é’®å®¹å™¨
            const ttsContainer = document.createElement('div');
            ttsContainer.className = 'tts-container';
            
            // åˆ›å»ºæœ—è¯»æŒ‰é’®
            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'tts-button';
            ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
            ttsBtn.title = 'ç‚¹å‡»æœ—è¯»ï¼ˆ' + msgLang + 'ï¼‰';
            
            // åˆ›å»ºåœæ­¢æŒ‰é’®
            const stopBtn = document.createElement('button');
            stopBtn.className = 'stop-button';
            stopBtn.innerHTML = 'â¹ï¸';
            stopBtn.title = 'åœæ­¢æœ—è¯»';
            stopBtn.style.display = 'none';
            
            // å½“å‰æ˜¯å¦åœ¨æœ—è¯»çš„æ ‡å¿—ï¼ˆé’ˆå¯¹è¿™æ¡æ¶ˆæ¯ï¼‰
            let isThisMessageSpeaking = false;
            
            // æœ—è¯»æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            ttsBtn.onclick = () => {
                if (isThisMessageSpeaking) {
                    // å¦‚æœæ­£åœ¨æœ—è¯»ï¼Œç‚¹å‡»åœæ­¢
                    stopSpeaking();
                    ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                    ttsBtn.classList.remove('speaking');
                    stopBtn.style.display = 'none';
                    isThisMessageSpeaking = false;
                } else {
                    // å¦‚æœæœªåœ¨æœ—è¯»ï¼Œå…ˆåœæ­¢å…¶ä»–æ‰€æœ‰æœ—è¯»
                    stopSpeaking();
                    
                    // å¼€å§‹æœ—è¯»è¿™æ¡æ¶ˆæ¯
                    speakText(text);
                    ttsBtn.innerHTML = 'ğŸ”‰' + langBadge;
                    ttsBtn.classList.add('speaking');
                    stopBtn.style.display = 'inline-flex';
                    isThisMessageSpeaking = true;
                    
                    // ç›‘å¬æœ—è¯»ç»“æŸäº‹ä»¶
                    if (currentUtterance) {
                        currentUtterance.onend = () => {
                            ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                            ttsBtn.classList.remove('speaking');
                            stopBtn.style.display = 'none';
                            isThisMessageSpeaking = false;
                            isCurrentlySpeaking = false;
                            currentUtterance = null;
                        };
                        
                        currentUtterance.onerror = () => {
                            ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                            ttsBtn.classList.remove('speaking');
                            stopBtn.style.display = 'none';
                            isThisMessageSpeaking = false;
                            isCurrentlySpeaking = false;
                            currentUtterance = null;
                        };
                    }
                }
            };
            
            // åœæ­¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            stopBtn.onclick = () => {
                stopSpeaking();
                ttsBtn.innerHTML = 'ğŸ”Š' + langBadge;
                ttsBtn.classList.remove('speaking');
                stopBtn.style.display = 'none';
                isThisMessageSpeaking = false;
            };
            
            // ç»„è£…ç»„ä»¶
            ttsContainer.appendChild(ttsBtn);
            ttsContainer.appendChild(stopBtn);
            
            messageDiv.appendChild(textSpan);
            if (sender === 'assistant') {
                messageDiv.appendChild(ttsContainer);
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        window.handleKeyPress = function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // è¯­éŸ³è¾“å…¥
        window.startVoiceInput = function() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.innerHTML = 'ğŸ¤ å½•éŸ³ä¸­...';
            voiceBtn.disabled = true;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chatInput').value = transcript;
            };

            recognition.onerror = (event) => {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                if (event.error === 'no-speech') {
                    alert('æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•');
                } else {
                    alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };

            recognition.onend = () => {
                voiceBtn.innerHTML = 'ğŸ¤ è¯­éŸ³';
                voiceBtn.disabled = false;
            };

            recognition.start();
        }

        // æ–‡å­—è½¬è¯­éŸ³ - æ™ºèƒ½è¯­è¨€æ£€æµ‹
        function speakText(text) {
            if (!text || !text.trim()) return;
            
            if (isCurrentlySpeaking) {
                stopSpeaking();
            }

            // æ¸…ç†æ–‡æœ¬ï¼šç§»é™¤emojisã€æ˜Ÿå·ã€ç ´æŠ˜å·ç­‰å¹²æ‰°ç¬¦å·
            const cleanedText = cleanTextForSpeech(text);
            
            if (!cleanedText.trim()) {
                console.log('æ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡æœ—è¯»');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            currentUtterance = utterance;
            
            // æ™ºèƒ½æ£€æµ‹è¯­è¨€
            const detectedLang = detectLanguage(cleanedText);
            utterance.lang = detectedLang;
            
            // æ ¹æ®è¯­è¨€è°ƒæ•´è¯­é€Ÿ
            if (detectedLang === 'de-DE') {
                utterance.rate = 0.85; // å¾·è¯­ç¨æ…¢
            } else if (detectedLang === 'en-US') {
                utterance.rate = 0.9;  // è‹±è¯­æ­£å¸¸
            } else {
                utterance.rate = 0.9;  // ä¸­æ–‡æ­£å¸¸
            }
            
            utterance.pitch = 1;
            utterance.volume = 1;
            
            // æœ—è¯»å®Œæˆåçš„åé¦ˆ
            utterance.onend = () => {
                console.log('æœ—è¯»å®Œæˆ:', detectedLang);
                isCurrentlySpeaking = false;
                currentUtterance = null;
                
                // é‡ç½®æ‰€æœ‰TTSæŒ‰é’®çŠ¶æ€
                resetAllTTSButtons();
            };
            
            utterance.onerror = (event) => {
                console.error('æœ—è¯»å‡ºé”™:', event);
                isCurrentlySpeaking = false;
                currentUtterance = null;
                
                // å‡ºé”™æ—¶ä¹Ÿé‡ç½®æŒ‰é’®çŠ¶æ€
                resetAllTTSButtons();
            };
            
            synthesis.speak(utterance);
            isCurrentlySpeaking = true;
        }

        // é‡ç½®æ‰€æœ‰TTSæŒ‰é’®çŠ¶æ€
        function resetAllTTSButtons() {
            const ttsButtons = document.querySelectorAll('.tts-button');
            ttsButtons.forEach(btn => {
                const originalHtml = btn.innerHTML;
                if (originalHtml.includes('ğŸ”‰')) {
                    const langBadge = originalHtml.replace('ğŸ”‰', '').trim();
                    btn.innerHTML = 'ğŸ”Š' + langBadge;
                    btn.classList.remove('speaking');
                }
            });
            
            const stopButtons = document.querySelectorAll('.stop-button');
            stopButtons.forEach(btn => {
                btn.style.display = 'none';
            });
        }

        // æ¸…ç†æ–‡æœ¬ç”¨äºè¯­éŸ³æ’­æ”¾ï¼ˆå¢å¼ºç‰ˆï¼‰
        function cleanTextForSpeech(text) {
            let cleaned = text;
            
            // æ­¥éª¤1: ç§»é™¤Markdownæ ¼å¼ç¬¦å·
            cleaned = cleaned.replace(/\*\*/g, '');          // ç²—ä½“æ ‡è®° **text**
            cleaned = cleaned.replace(/\*/g, '');            // æ–œä½“æ ‡è®° *text*
            cleaned = cleaned.replace(/~~(.+?)~~/g, '$1');   // åˆ é™¤çº¿ ~~text~~
            cleaned = cleaned.replace(/`([^`]+)`/g, '$1');   // è¡Œå†…ä»£ç  `code`
            cleaned = cleaned.replace(/```[\s\S]*?```/g, ''); // ä»£ç å—
            cleaned = cleaned.replace(/#{1,6}\s*/g, '');     // æ ‡é¢˜æ ‡è®° # ## ###
            cleaned = cleaned.replace(/^\s*[-*+]\s+/gm, ''); // åˆ—è¡¨é¡¹ - * +
            cleaned = cleaned.replace(/^\s*\d+\.\s+/gm, ''); // æ•°å­—åˆ—è¡¨ 1. 2. 3.
            cleaned = cleaned.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1'); // é“¾æ¥ [text](url)
            
            // æ­¥éª¤2: ç§»é™¤emojiï¼ˆå¸¦ä¿æŠ¤ï¼‰
            try {
                cleaned = cleaned.replace(/[\u{1F600}-\u{1F64F}]/gu, '');
                cleaned = cleaned.replace(/[\u{1F300}-\u{1F5FF}]/gu, '');
                cleaned = cleaned.replace(/[\u{1F680}-\u{1F6FF}]/gu, '');
                cleaned = cleaned.replace(/[\u{1F900}-\u{1F9FF}]/gu, '');
                cleaned = cleaned.replace(/[\u{2600}-\u{26FF}]/gu, '');
                cleaned = cleaned.replace(/[\u{2700}-\u{27BF}]/gu, '');
            } catch(e) {
                console.log('Emojiæ¸…ç†è·³è¿‡');
            }
            
            // æ­¥éª¤3: ç§»é™¤å…¶ä»–ç‰¹æ®Šç¬¦å·
            cleaned = cleaned.replace(/â€”â€”+/g, 'ï¼Œ');         // ä¸­æ–‡ç ´æŠ˜å·è½¬ä¸ºé€—å·
            cleaned = cleaned.replace(/--+/g, ' ');          // è‹±æ–‡ç ´æŠ˜å·
            cleaned = cleaned.replace(/â€”+/g, ' ');           // emç ´æŠ˜å·
            cleaned = cleaned.replace(/_+/g, ' ');           // ä¸‹åˆ’çº¿
            cleaned = cleaned.replace(/[â—â—‹â– â–¡â—†â—‡â˜…â˜†â–²â–³â–¼â–½]/g, ''); // ç‰¹æ®Šå½¢çŠ¶
            cleaned = cleaned.replace(/[â€¢Â·]/g, '');          // é¡¹ç›®ç¬¦å·
            cleaned = cleaned.replace(/[ã€Œã€ã€ã€ã€ã€‘ã€Šã€‹ã€ˆã€‰]/g, ''); // ä¸­æ–‡å¼•å·
            
            // æ­¥éª¤4: æ¸…ç†å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
            cleaned = cleaned.replace(/\n\s*\n/g, 'ã€‚');     // å¤šä¸ªæ¢è¡Œè½¬ä¸ºå¥å·
            cleaned = cleaned.replace(/\n/g, 'ï¼Œ');          // å•ä¸ªæ¢è¡Œè½¬ä¸ºé€—å·
            cleaned = cleaned.replace(/\s+/g, ' ');          // å¤šä½™ç©ºæ ¼
            cleaned = cleaned.trim();
            
            // æ­¥éª¤5: ç¡®ä¿å¥å­æµç•…
            cleaned = cleaned.replace(/[,ï¼Œ]\s*[,ï¼Œ]/g, 'ï¼Œ'); // å»é™¤é‡å¤é€—å·
            cleaned = cleaned.replace(/[.ã€‚]\s*[.ã€‚]/g, 'ã€‚'); // å»é™¤é‡å¤å¥å·
            
            return cleaned;
        }

        // åœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾
        window.stopSpeaking = function() {
            if (synthesis.speaking) {
                synthesis.cancel();
                console.log('å·²åœæ­¢æœ—è¯»');
            }
            
            isCurrentlySpeaking = false;
            currentUtterance = null;
            
            // é‡ç½®æ‰€æœ‰TTSæŒ‰é’®çŠ¶æ€
            resetAllTTSButtons();
        }

        // åŒ»å­¦è¾å…¸åŠŸèƒ½
        window.translateTerm = async function() {
            const input = document.getElementById('dictInput').value.trim();
            const sourceLang = document.getElementById('sourceLang').value;
            const resultDiv = document.getElementById('translationResult');

            if (!input) {
                resultDiv.innerHTML = '<p style="color: #dc3545;">è¯·è¾“å…¥è¦ç¿»è¯‘çš„æœ¯è¯­</p>';
                return;
            }

            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="typing-indicator" style="margin: 0 auto;">
                        <span class="heart">ğŸ’™</span>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <p style="margin-top: 15px; color: #667eea;">æ­£åœ¨ç¿»è¯‘ä¸­...</p>
                </div>
            `;

            try {
                const response = await fetch('/.netlify/functions/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        term: input,
                        sourceLang: sourceLang
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                const translation = data.choices[0].message.content;

                resultDiv.innerHTML = `
                    <div class="term-card">
                        <h3>ğŸ“– ç¿»è¯‘ç»“æœ</h3>
                        <div style="white-space: pre-wrap; line-height: 1.8; padding: 10px; background: white; border-radius: 5px;" id="translationText">${translation}</div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="speakTranslationText('${translation.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š è‡ªåŠ¨è¯†åˆ«æœ—è¯»
                            </button>
                            <button onclick="speakTranslation('zh-CN')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š ä¸­æ–‡æœ—è¯»
                            </button>
                            <button onclick="speakTranslation('en-US')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š English
                            </button>
                            <button onclick="speakTranslation('de-DE')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š Deutsch
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('ç¿»è¯‘é”™è¯¯:', error);
                resultDiv.innerHTML = '<p class="error-message">ç¿»è¯‘å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }

        // ç¿»è¯‘ç»“æœæœ—è¯»ï¼ˆæŒ‡å®šè¯­è¨€ï¼‰
        window.speakTranslation = function(lang) {
            const translationDiv = document.getElementById('translationText');
            if (!translationDiv) return;

            const text = translationDiv.textContent;
            if (!text.trim()) return;

            if (isCurrentlySpeaking) {
                stopSpeaking();
            }

            // æ¸…ç†æ–‡æœ¬
            const cleanedText = cleanTextForSpeech(text);
            
            if (!cleanedText.trim()) {
                console.log('æ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡æœ—è¯»');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            currentUtterance = utterance;
            utterance.lang = lang;
            
            // æ ¹æ®è¯­è¨€è°ƒæ•´è¯­é€Ÿ
            if (lang === 'de-DE') {
                utterance.rate = 0.85;
            } else if (lang === 'en-US') {
                utterance.rate = 0.9;
            } else {
                utterance.rate = 0.9;
            }
            
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onend = () => {
                isCurrentlySpeaking = false;
                currentUtterance = null;
            };
            
            utterance.onerror = () => {
                isCurrentlySpeaking = false;
                currentUtterance = null;
            };
            
            synthesis.speak(utterance);
            isCurrentlySpeaking = true;
        }

        // ç¿»è¯‘ç»“æœè‡ªåŠ¨è¯†åˆ«æœ—è¯»
        window.speakTranslationText = function(text) {
            if (!text || !text.trim()) return;

            if (isCurrentlySpeaking) {
                stopSpeaking();
            }

            // æ¸…ç†æ–‡æœ¬
            const cleanedText = cleanTextForSpeech(text);
            
            if (!cleanedText.trim()) {
                console.log('æ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡æœ—è¯»');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            currentUtterance = utterance;
            
            // æ™ºèƒ½æ£€æµ‹è¯­è¨€
            const detectedLang = detectLanguage(cleanedText);
            utterance.lang = detectedLang;
            
            // æ ¹æ®è¯­è¨€è°ƒæ•´è¯­é€Ÿ
            if (detectedLang === 'de-DE') {
                utterance.rate = 0.85;
            } else if (detectedLang === 'en-US') {
                utterance.rate = 0.9;
            } else {
                utterance.rate = 0.9;
            }
            
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onend = () => {
                isCurrentlySpeaking = false;
                currentUtterance = null;
            };
            
            utterance.onerror = () => {
                isCurrentlySpeaking = false;
                currentUtterance = null;
            };
            
            synthesis.speak(utterance);
            isCurrentlySpeaking = true;
        }

        // éšè®¿æé†’åŠŸèƒ½
        window.addReminder = function() {
            const patientName = document.getElementById('patientName').value.trim();
            const surgeryType = document.getElementById('surgeryType').value.trim();
            const followupDate = document.getElementById('followupDate').value;
            const notes = document.getElementById('notes').value.trim();

            if (!patientName || !surgeryType || !followupDate) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            const reminder = {
                id: Date.now(),
                patientName,
                surgeryType,
                followupDate,
                notes,
                createdAt: new Date().toISOString()
            };

            reminders.push(reminder);
            localStorage.setItem('reminders', JSON.stringify(reminders));

            // æ¸…ç©ºè¡¨å•
            document.getElementById('patientName').value = '';
            document.getElementById('surgeryType').value = '';
            document.getElementById('followupDate').value = '';
            document.getElementById('notes').value = '';

            displayReminders();
            alert('éšè®¿æé†’å·²æ·»åŠ ');
        }

        function displayReminders() {
            const listDiv = document.getElementById('reminderList');
            const today = new Date().toISOString().split('T')[0];

            if (reminders.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">æš‚æ— éšè®¿æé†’</p>';
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            reminders.sort((a, b) => new Date(a.followupDate) - new Date(b.followupDate));

            listDiv.innerHTML = reminders.map(reminder => {
                const followupDate = new Date(reminder.followupDate);
                const isPast = reminder.followupDate < today;
                const isUpcoming = !isPast && (new Date(reminder.followupDate) - new Date(today)) / (1000 * 60 * 60 * 24) <= 7;
                const statusClass = isPast ? 'overdue' : isUpcoming ? 'upcoming' : '';

                return `
                    <div class="reminder-item ${statusClass}">
                        <div>
                            <strong>${reminder.patientName}</strong> - ${reminder.surgeryType}<br>
                            <small>ğŸ“… éšè®¿æ—¥æœŸ: ${reminder.followupDate}</small><br>
                            ${reminder.notes ? `<small>ğŸ“ ${reminder.notes}</small>` : ''}
                        </div>
                        <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="deleteReminder(${reminder.id})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');
        }

        window.deleteReminder = function(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æé†’å—ï¼Ÿ')) {
                reminders = reminders.filter(r => r.id !== id);
                localStorage.setItem('reminders', JSON.stringify(reminders));
                displayReminders();
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            const welcomeMsg = `æ‚¨å¥½ï¼æˆ‘æ˜¯å°å„¿å¿ƒè„å¤–ç§‘æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”ä¸“ä¸šé—®é¢˜ã€æä¾›å‚è€ƒä¿¡æ¯ã€‚
            
æ”¯æŒè¯­è¨€ï¼š
ğŸ‡¨ğŸ‡³ ä¸­æ–‡ - è¯·ç”¨ä¸­æ–‡æé—®ï¼Œæˆ‘å°†ç”¨ä¸­æ–‡å›å¤
ğŸ‡ºğŸ‡¸ English - Ask in English, I'll reply in English
ğŸ‡©ğŸ‡ª Deutsch - Fragen Sie auf Deutsch, ich antworte auf Deutsch

è¯­éŸ³åŠŸèƒ½ï¼š
â€¢ ç‚¹å‡»ğŸ¤æŒ‰é’®å¯ä½¿ç”¨è¯­éŸ³è¾“å…¥æé—®
â€¢ ç‚¹å‡»æ¶ˆæ¯æ—çš„ğŸ”ŠæŒ‰é’®å¯æœ—è¯»è¯¥æ¡æ¶ˆæ¯
â€¢ ç‚¹å‡»â¹ï¸æŒ‰é’®å¯åœæ­¢å½“å‰æœ—è¯»
â€¢ ç‚¹å‡»åº•éƒ¨çš„ğŸ”‡æŒ‰é’®å¯åœæ­¢æ‰€æœ‰æœ—è¯»

è¯·æ³¨æ„ï¼Œæ‰€æœ‰å»ºè®®ä»…ä¾›å‚è€ƒï¼Œå®é™…è¯Šç–—éœ€ç»“åˆæ‚£å„¿å…·ä½“æƒ…å†µç”±åŒ»ç”Ÿåˆ¤æ–­ã€‚`;
            
            addMessage(welcomeMsg, 'assistant');
            
            // åŠ è½½éšè®¿æé†’
            displayReminders();
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        // æ£€æŸ¥åˆ°æœŸæé†’
        setInterval(() => {
            const today = new Date().toISOString().split('T')[0];
            const dueReminders = reminders.filter(r => r.followupDate === today);
            
            if (dueReminders.length > 0 && Notification.permission === 'granted') {
                dueReminders.forEach(reminder => {
                    new Notification('éšè®¿æé†’', {
                        body: `æ‚£è€… ${reminder.patientName} ä»Šæ—¥éœ€è¦éšè®¿ (${reminder.surgeryType})`,
                        icon: 'ğŸ«€'
                    });
                });
            }
        }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>