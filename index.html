<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatric Cardiac SurgeryåŠ©æ‰‹</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ«€</text></svg>">
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .disclaimer { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px; border-radius: 5px; font-size: 0.9em; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border: none; background: transparent; font-weight: 500; }
        .tab.active { background: white; border-bottom: 3px solid #667eea; color: #667eea; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .chat-container { display: flex; flex-direction: column; height: 500px; border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }
        .message { margin-bottom: 15px; padding: 12px 16px; border-radius: 10px; max-width: 80%; line-height: 1.5; }
        .message.user { background: #667eea; color: white; margin-left: auto; }
        .message.assistant { background: white; border: 1px solid #dee2e6; }
        .chat-input-container { display: flex; gap: 10px; padding: 15px; background: white; border-top: 1px solid #dee2e6; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #dee2e6; border-radius: 25px; outline: none; }
        .btn { padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .thinking-animation { display: flex; gap: 4px; padding: 10px; }
        .thinking-animation .bubble { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: think 1s infinite; }
        @keyframes think { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .tts-button { margin-left: 10px; cursor: pointer; background: none; border: none; font-size: 1.2em; }
        .dictionary-container { max-width: 800px; margin: 0 auto; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .reminder-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ«€ Pediatric Cardiac SurgeryåŠ©æ‰‹</h1>
            <p>å©´å¹¼å„¿å¿ƒå¤–ç§‘æ™ºèƒ½è¾…åŠ©ç³»ç»Ÿ - åˆ˜èåŒ»å¸ˆè®¾è®¡</p>
        </div>

        <div class="disclaimer">
            <strong>âš ï¸ å…è´£å£°æ˜:</strong> æœ¬ç³»ç»Ÿä¿¡æ¯ä»…ä¾›ä¸´åºŠå‚è€ƒï¼Œä¸èƒ½ä»£æ›¿ä¸“ä¸šåŒ»ç–—åˆ¤æ–­ã€‚
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ¤– AIåŠ©æ‰‹</button>
            <button class="tab" onclick="switchTab(1)">ğŸ“š åŒ»å­¦è¾å…¸</button>
            <button class="tab" onclick="switchTab(2)">â° éšè®¿æé†’</button>
        </div>

        <div class="tab-content active">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                </div>
            </div>
            <div style="margin-top:10px; font-size:0.8em; color: #666;">æ”¯æŒä¸­ã€è‹±ã€å¾·è¯­è‡ªåŠ¨è¯†åˆ«</div>
        </div>

        <div class="tab-content">
            <div class="dictionary-container">
                <div class="search-box">
                    <input type="text" id="dictInput" class="chat-input" style="border-radius:10px" placeholder="åŒ»å­¦æœ¯è¯­...">
                    <button class="btn btn-primary" onclick="translateTerm()">ç¿»è¯‘</button>
                </div>
                <div id="translationResult"></div>
            </div>
        </div>

        <div class="tab-content">
            <div id="reminderList"></div>
        </div>
    </div>

    <script>
        let chatHistory = [];
        const synthesis = window.speechSynthesis;

        function switchTab(idx) {
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
            document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === idx));
        }

        function detectLang(text) {
            if (/[\u4e00-\u9fa5]/.test(text)) return 'zh-CN';
            // å¼ºåŒ–å¾·è¯­å…³é”®è¯æ£€æµ‹
            const deWords = /\b(der|die|das|und|ist|herz|chirurgie|hilfe|bitte|neonaten)\b/i;
            if (/[Ã¤Ã¶Ã¼ÃŸÃ„Ã–Ãœ]/.test(text) || deWords.test(text)) return 'de-DE';
            return 'en-US';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';
            
            const tid = addThinking();
            const lang = detectLang(message);
            
            // æ ¸å¿ƒä¿®å¤ï¼šæ ¹æ®è¯­è¨€ç¡¬æ€§è§„å®šå›å¤æŒ‡ä»¤
            let sysCmd = "You are a cardiac surgery assistant.";
            let userTagged = message;
            
            if (lang === 'zh-CN') {
                sysCmd = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŒ»ç”ŸåŠ©æ‰‹ï¼Œå¿…é¡»ä½¿ç”¨ä¸­æ–‡å›ç­”ã€‚";
            } else if (lang === 'de-DE') {
                sysCmd = "Du bist ein professioneller Assistent fÃ¼r Kinderherzchirurgie. ANTWORTE BITTE NUR AUF DEUTSCH.";
                userTagged += " (Antworte bitte auf Deutsch)";
            }

            try {
                const res = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{role: 'system', content: sysCmd}, ...chatHistory, {role: 'user', content: userTagged}],
                        temperature: 0.3
                    })
                });
                
                const data = await res.json();
                removeThinking(tid);
                const reply = data.choices[0].message.content;
                
                chatHistory.push({role: 'user', content: message}, {role: 'assistant', content: reply});
                addMessage(reply, 'assistant');
            } catch (e) {
                removeThinking(tid);
                addMessage("Error: Connection failed.", 'assistant');
            }
        }

        function addMessage(text, sender) {
            const box = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            const span = document.createElement('span');
            span.textContent = text;
            div.appendChild(span);

            if (sender === 'assistant') {
                const btn = document.createElement('button');
                btn.className = 'tts-button';
                btn.innerHTML = 'ğŸ”Š';
                btn.onclick = () => {
                    synthesis.cancel();
                    const ut = new SpeechSynthesisUtterance(text);
                    ut.lang = detectLang(text);
                    synthesis.speak(ut);
                };
                div.appendChild(btn);
            }
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function addThinking() {
            const id = 't-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message assistant';
            div.innerHTML = '<div class="thinking-animation"><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div></div>';
            document.getElementById('chatMessages').appendChild(div);
            return id;
        }

        function removeThinking(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        async function translateTerm() {
            const val = document.getElementById('dictInput').value;
            const resDiv = document.getElementById('translationResult');
            resDiv.innerHTML = "Translating...";
            try {
                const res = await fetch('/.netlify/functions/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ term: val })
                });
                const data = await res.json();
                resDiv.innerHTML = `<div style="padding:15px; background:#f0f0f0; border-radius:10px; margin-top:10px">${data.choices[0].message.content}</div>`;
            } catch (e) { resDiv.innerHTML = "Error."; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            addMessage("æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„å¿ƒå¤–ç§‘åŠ©æ‰‹ã€‚æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€å¾·è¯­äº¤æµã€‚", 'assistant');
        });
    </script>
</body>
</html>