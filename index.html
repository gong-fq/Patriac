<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatric Cardiac SurgeryåŠ©æ‰‹</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ«€</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .disclaimer { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px; border-radius: 5px; font-size: 0.9em; line-height: 1.6; }
        .disclaimer strong { color: #856404; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; border: none; background: transparent; font-size: 1em; font-weight: 500; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; border-bottom: 3px solid #667eea; color: #667eea; }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-container { display: flex; flex-direction: column; height: 500px; border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }
        .message { margin-bottom: 15px; padding: 12px 16px; border-radius: 10px; max-width: 80%; line-height: 1.5; word-wrap: break-word; }
        .message.user { background: #667eea; color: white; margin-left: auto; text-align: right; }
        .message.assistant { background: white; border: 1px solid #dee2e6; }
        .chat-input-container { display: flex; gap: 10px; padding: 15px; background: white; border-top: 1px solid #dee2e6; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #dee2e6; border-radius: 25px; font-size: 1em; outline: none; }
        .btn { padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-size: 1em; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .dictionary-container { max-width: 800px; margin: 0 auto; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 1em; }
        .lang-selector { padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 1em; cursor: pointer; }
        .translation-result { background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 200px; margin-top: 20px; }
        .term-card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #667eea; }
        .reminder-form { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; font-size: 1em; }
        .reminder-list { margin-top: 20px; }
        .reminder-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #28a745; display: flex; justify-content: space-between; align-items: center; }
        .reminder-item.overdue { border-left-color: #dc3545; }
        .reminder-item.upcoming { border-left-color: #ffc107; }
        .resources { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .resources h3 { margin-bottom: 15px; color: #667eea; }
        .resources ul { list-style: none; }
        .resources li { padding: 10px 0; border-bottom: 1px solid #dee2e6; }
        .resources a { color: #667eea; text-decoration: none; transition: color 0.3s; }
        .resources a:hover { color: #764ba2; text-decoration: underline; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .typing-indicator { display: inline-flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border: 1px solid #dee2e6; border-radius: 10px; max-width: 80px; }
        .typing-indicator .heart { font-size: 24px; animation: heartbeat 1.2s ease-in-out infinite; }
        .typing-indicator .dot { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s ease-in-out infinite; }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 10%, 30% { transform: scale(1.1); } 20%, 40% { transform: scale(1); } }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); opacity: 0.7; } 30% { transform: translateY(-10px); opacity: 1; } }
        .thinking-animation { display: inline-flex; align-items: center; gap: 4px; padding: 12px 16px; background: white; border: 1px solid #dee2e6; border-radius: 10px; }
        .thinking-animation .bubble { width: 10px; height: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; animation: think 1.5s ease-in-out infinite; }
        .thinking-animation .bubble:nth-child(1) { animation-delay: 0s; }
        .thinking-animation .bubble:nth-child(2) { animation-delay: 0.3s; }
        .thinking-animation .bubble:nth-child(3) { animation-delay: 0.6s; }
        @keyframes think { 0%, 100% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } }
        .error-message { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .tts-button { background: none; border: none; cursor: pointer; font-size: 1.2em; opacity: 0.7; transition: all 0.3s; padding: 4px; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .tts-button:hover { opacity: 1; background-color: #f0f0f0; }
        .tts-button.speaking { opacity: 1; background-color: #e3f2fd; }
        .stop-button { background: none; border: none; cursor: pointer; font-size: 1.1em; opacity: 0.7; transition: all 0.3s; padding: 4px; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .stop-button:hover { opacity: 1; background-color: #ffebee; }
        .tts-container { display: inline-flex; align-items: center; gap: 5px; margin-left: 10px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ«€ Pediatric Cardiac SurgeryåŠ©æ‰‹</h1>
            <p>å©´å¹¼å„¿å¿ƒå¤–ç§‘æ™ºèƒ½è¾…åŠ©ç³»ç»Ÿ</p>
            <p>å¤©æ´¥èƒ¸ç§‘åŒ»é™¢å¿ƒè¡€ç®¡å¤–ç§‘åŒ»å¸ˆåˆ˜èè®¾è®¡</p>
        </div>

        <div class="disclaimer">
            <strong>âš ï¸ å…è´£å£°æ˜ / Disclaimer:</strong><br>
            æœ¬ç³»ç»Ÿæä¾›çš„ä¿¡æ¯ä»…ä¾›ä¸´åºŠå©´å¹¼å„¿å¿ƒå¤–ç§‘åŒ»ç”Ÿå‚è€ƒï¼Œä¸èƒ½ä»£æ›¿ä¸“ä¸šåŒ»ç–—åˆ¤æ–­ã€‚æ‰€æœ‰ä¸´åºŠå†³ç­–å¿…é¡»ç»“åˆæ‚£å„¿çš„å…·ä½“æƒ…å†µã€æœ€æ–°åŒ»å­¦è¯æ®å’ŒåŒ»ç”Ÿçš„ä¸“ä¸šç»éªŒç»¼åˆåˆ¤æ–­ã€‚ä½¿ç”¨æœ¬ç³»ç»Ÿå³è¡¨ç¤ºæ‚¨åŒæ„æ­¤å…è´£å£°æ˜ã€‚
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ¤– AIåŠ©æ‰‹</button>
            <button class="tab" onclick="switchTab(1)">ğŸ“š åŒ»å­¦è¾å…¸</button>
            <button class="tab" onclick="switchTab(2)">â° éšè®¿æé†’</button>
            <button class="tab" onclick="switchTab(3)">ğŸ”— å‚è€ƒèµ„æº</button>
        </div>

        <div class="tab-content active">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€å¾·è¯­ï¼‰..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-secondary" onclick="startVoiceInput()" id="voiceBtn">ğŸ¤ è¯­éŸ³</button>
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #6c757d; font-size: 0.9em;">ğŸ¤ è¯­éŸ³è¾“å…¥æé—® | ğŸ”Š ç‚¹å‡»æ¶ˆæ¯æŒ‰é’®æœ—è¯» | â¹ï¸ åœæ­¢å½“å‰æœ—è¯»</div>
                <button onclick="stopSpeaking()" class="btn btn-secondary" style="padding: 8px 16px;">ğŸ”‡ åœæ­¢æ‰€æœ‰æœ—è¯»</button>
            </div>
        </div>

        <div class="tab-content">
            <div class="dictionary-container">
                <h2 style="margin-bottom: 20px;">åŒ»å­¦æœ¯è¯­ç¿»è¯‘</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="dictInput" placeholder="è¾“å…¥åŒ»å­¦æœ¯è¯­...">
                    <select class="lang-selector" id="sourceLang">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                    </select>
                    <button class="btn btn-primary" onclick="translateTerm()">ç¿»è¯‘</button>
                </div>
                <div class="translation-result" id="translationResult">
                    <p style="color: #6c757d;">åœ¨ä¸Šæ–¹è¾“å…¥æœ¯è¯­è¿›è¡Œç¿»è¯‘...</p>
                </div>
            </div>
        </div>

        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">æ‚£è€…éšè®¿ç®¡ç†</h2>
            <div class="reminder-form">
                <h3>æ·»åŠ éšè®¿æé†’</h3>
                <div class="form-group"><label>æ‚£è€…å§“å/ID:</label><input type="text" id="patientName"></div>
                <div class="form-group"><label>æ‰‹æœ¯ç±»å‹:</label><input type="text" id="surgeryType"></div>
                <div class="form-group"><label>éšè®¿æ—¥æœŸ:</label><input type="date" id="followupDate"></div>
                <div class="form-group"><label>å¤‡æ³¨:</label><textarea id="notes" rows="3"></textarea></div>
                <button class="btn btn-primary" onclick="addReminder()">æ·»åŠ æé†’</button>
            </div>
            <div class="reminder-list" id="reminderList"></div>
        </div>

        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">ä¸»è¦å‚è€ƒåŒ»ç–—æœºæ„</h2>
            <div class="resources">
                <h3>ğŸŒ å›½é™…é¡¶å°–å„¿ç«¥å¿ƒè„ä¸­å¿ƒ</h3>
                <ul>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.dhzc.charite.de/en/" target="_blank">DHZC - æŸæ—å¤é‡Œç‰¹å¿ƒè„ä¸­å¿ƒ</a></li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.chop.edu/centers-programs/cardiac-center" target="_blank">CHOP - è´¹åŸå„¿ç«¥åŒ»é™¢</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        let chatHistory = [];
        let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isCurrentlySpeaking = false;
        let currentUtterance = null;

        window.switchTab = function(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach((tab, i) => tab.classList.toggle('active', i === index));
            contents.forEach((content, i) => content.classList.toggle('active', i === index));
            if (index === 2) displayReminders();
        };

        function detectLanguage(text) {
            if (!text) return 'en-US';
            if (/[\u4e00-\u9fa5]/.test(text)) return 'zh-CN';
            const deWords = /\b(der|die|das|ein|und|ist|herz|chirurgie|kinder)\b/i;
            if (/[Ã¤Ã¶Ã¼ÃŸÃ„Ã–Ãœ]/.test(text) || deWords.test(text)) return 'de-DE';
            return 'en-US';
        }

        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';
            const thinkingId = addThinkingAnimation();
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            const userLang = detectLanguage(message);
            let systemPrompt = "You are a pediatric cardiac surgery assistant.";
            let userPrompt = message;

            if (userLang === 'zh-CN') {
                systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°å„¿å¿ƒè„å¤–ç§‘åŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡å›ç­”ã€‚";
                userPrompt += " (Bitte auf Chinesisch antworten)";
            } else if (userLang === 'de-DE') {
                systemPrompt = "Sie sind ein professioneller Assistent fÃ¼r Kinderherzchirurgie. Antworten Sie BITTE NUR auf DEUTSCH.";
                userPrompt += " (Bitte auf Deutsch antworten)";
            }

            try {
                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'system', content: systemPrompt }, ...chatHistory, { role: 'user', content: userPrompt }],
                        temperature: 0.3
                    })
                });
                removeThinkingAnimation(thinkingId);
                const data = await response.json();
                const reply = data.choices[0].message.content;
                chatHistory.push({ role: 'user', content: message }, { role: 'assistant', content: reply });
                addMessage(reply, 'assistant');
            } catch (error) {
                removeThinkingAnimation(thinkingId);
                addMessage("Error: " + error.message, 'assistant');
            } finally {
                sendBtn.disabled = false;
            }
        };

        function addThinkingAnimation() {
            const messagesDiv = document.getElementById('chatMessages');
            const id = 'think-' + Date.now();
            const div = document.createElement('div');
            div.id = id; div.className = 'message assistant';
            div.innerHTML = '<div class="thinking-animation"><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div></div>';
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return id;
        }

        function removeThinkingAnimation(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            div.appendChild(textSpan);

            if (sender === 'assistant') {
                const lang = detectLanguage(text);
                const btn = document.createElement('button');
                btn.className = 'tts-button';
                btn.innerHTML = 'ğŸ”Š';
                btn.onclick = () => speakText(text, lang);
                div.appendChild(btn);
            }
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        window.handleKeyPress = (e) => { if (e.key === 'Enter') sendMessage(); };

        window.startVoiceInput = function() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.onresult = (e) => { document.getElementById('chatInput').value = e.results[0][0].transcript; };
            recognition.start();
        };

        function speakText(text, lang) {
            synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text.replace(/[*#`]/g, ''));
            utterance.lang = lang;
            utterance.rate = 0.9;
            synthesis.speak(utterance);
        }

        window.stopSpeaking = () => synthesis.cancel();

        window.translateTerm = async function() {
            const input = document.getElementById('dictInput').value.trim();
            const lang = document.getElementById('sourceLang').value;
            const resDiv = document.getElementById('translationResult');
            if (!input) return;
            resDiv.innerHTML = "æ­£åœ¨ç¿»è¯‘...";
            try {
                const response = await fetch('/.netlify/functions/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ term: input, sourceLang: lang })
                });
                const data = await response.json();
                const result = data.choices[0].message.content;
                resDiv.innerHTML = `<div class="term-card"><h3>ç»“æœ</h3><p id="tResultText">${result}</p><button class="btn btn-secondary" onclick="speakText(document.getElementById('tResultText').textContent, 'zh-CN')">æœ—è¯»</button></div>`;
            } catch (e) { resDiv.innerHTML = "ç¿»è¯‘å‡ºé”™"; }
        };

        window.addReminder = function() {
            const name = document.getElementById('patientName').value;
            const date = document.getElementById('followupDate').value;
            if (!name || !date) return alert("è¯·å¡«å†™å®Œæ•´");
            reminders.push({ id: Date.now(), name, date, type: document.getElementById('surgeryType').value });
            localStorage.setItem('reminders', JSON.stringify(reminders));
            displayReminders();
        };

        function displayReminders() {
            const list = document.getElementById('reminderList');
            list.innerHTML = reminders.map(r => `<div class="reminder-item"><div><strong>${r.name}</strong> - ${r.date}</div><button onclick="deleteReminder(${r.id})">åˆ é™¤</button></div>`).join('');
        }

        window.deleteReminder = (id) => {
            reminders = reminders.filter(r => r.id !== id);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            displayReminders();
        };

        document.addEventListener('DOMContentLoaded', () => {
            addMessage("æ‚¨å¥½ï¼æˆ‘æ˜¯å°å„¿å¿ƒè„å¤–ç§‘æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä¸“ä¸šå’¨è¯¢å’Œç¿»è¯‘æ”¯æŒã€‚", 'assistant');
            displayReminders();
        });
    </script>
</body>
</html>